---
title: "Heat Safety Alerts"
format:
  html:
    theme: cosmo
    df-print: paged
    toc: true
    toc-depth: 2
    code-tools: true
---

## Summary 

This notebook works through creating heat safetey alerts for a specific location.

## Setup

```{r chunk01, message=FALSE}
library(dplyr)
library(sf)
library(readxl)
library(ggplot2)
library(fs)
```

Define the data directory (relative to this notebook):

```{r chunk02}
data_dir <- "data"
dir_exists(data_dir)
```
## Define a Location

Select a point:

```{r chunk03}
pt_coords <- c(-121.049, 37.621)
```

Get the weather forecast for tomorrow

```{r chunk04}
library(openmeteo)
pt_forecast_tbl <- weather_forecast(location = pt_coords[c(2,1)], 
                                    hourly = c("temperature_2m", "dew_point_2m", 
                                               "wind_speed_10m", "shortwave_radiation"),
                                    response_units = list(
                                      temperature_unit = "celsius",
                                      windspeed_unit = "ms"),
                                    start = Sys.Date() + 1, 
                                    end = Sys.Date() + 1) |> 
  rename(tas_c = hourly_temperature_2m, 
         dewp_c = hourly_dew_point_2m,
         wind_ms = hourly_wind_speed_10m, 
         radiation = hourly_shortwave_radiation) 
```

Inspect:

```{r chunk05}
pt_forecast_tbl
```


Compute the wet bulb globe temperature:

```{r chunk06}
library(HeatStress)
pt_wbgt_lst <- with(pt_forecast_tbl,
                    wbgt.Liljegren(
                      tas = tas_c,
                      dewp = dewp_c,
                      wind = wind_ms,
                      radiation = radiation,
                      dates = datetime,
                      lon = pt_coords[1],
                      lat = pt_coords[2],
                      hour = TRUE))

pt_wbgt_lst$data
```

Save the max:

```{r chunk07}
pt_wbgt_max <- max(pt_wbgt_lst$data)
```

## Extract the Percent of the Workforce in Agriculture

Load a geojson file containing the percent of the workforce in agriculture (from the ACS):

```{r chunk08}
library(sf)
ca_agemp_sf <- st_read(path_abs(path(data_dir, "ca_ag_emp.geojson")))
```

Inspect it:

```{r chunk09}
head(ca_agemp_sf)

ggplot() +
    geom_sf(data = ca_agemp_sf, mapping = aes(fill = ag_pct)) 
```

## Find the census tract for our selected point:

Convert the point into a sf object:

```{r chunk10}
pt_sf <- st_as_sf(data.frame(id=1, lon=pt_coords[1], lat=pt_coords[2]),
                  coords = c("lon", "lat"),
                  crs = 4326)
```

Get the tract with a spatial join:

```{r chunk11}
pt_agemp_sf <- st_join(pt_sf, ca_agemp_sf, join = st_intersects)

pt_agemp_sf
```

Save the tract id and the percent of the laborforce in ag:

```{r chunk12}
(tract_id_chr <- pt_agemp_sf$GEOID)

pt_agemp <- ca_agemp_sf |> 
  st_drop_geometry() |> 
  filter(GEOID == tract_id_chr) |> 
  pull(ag_pct)

pt_agemp
```

## Get the CalEnviroScreen 4.0 Socioeconomic Metrics

Read in the CES Excel File:

```{r chunk13}
library(readxl)
ces4_fn <- path(data_dir, "calenviroscreen40resultsdatadictionary_F_2021.xlsx")
file_exists(ces4_fn)
ces4_tbl <- readxl::read_xlsx(ces4_fn, sheet = "CES4.0FINAL_results", na = c("", NA)) 
```

Inspect:

```{r chunk14}
dim(ces4_tbl)
names(ces4_tbl)
head(ces4_tbl)
```

Pull out just the socioeconomic variables:

```{r chunk15}
ces4_socecon_tbl <- ces4_tbl |> 
  select(GEOID = `Census Tract`,
         total_pop = `Total Population`,
         county = `California County`,
         pov_raw = Poverty,
         unemp_raw = Unemployment,
         housing_burden_raw = `Housing Burden`,
         educ_raw = Education,
         ling_iso_raw = `Linguistic Isolation`)

names(ces4_socecon_tbl)
```

Get the socioeconomic variables for our census tract (as a list):

```{r chunk16}
pt_socecon_lst <- ces4_socecon_tbl |> 
  filter(GEOID == as.numeric(tract_id_chr)) |> 
  as.list()

pt_socecon_lst
```

## Create Safety Messages

Create a function for the safety messages:

```{r chunk17}
safety_msg <- function(wbgt, ag_pct, pov_raw, ling_iso_raw) {
  
  if (wbgt > 90) {
    flag = "black"
    msg = "Stop all outdoor activity"
  } else if (wbgt >= 88.0) {
    flag = "red"
    msg = "Stop all outdoor training for unacclimatized personnel."
  } else if (wbgt >= 85.0) {
    flag = "yellow"
    msg = "Limit intense exercise to 1 hour; 15 mins rest per hour."
  } else if (wbgt >= 80.0) {
    flag = "green"
    msg = "Use discretion in planning heavy exercise."
  } else {
    flag = "white"
    msg = "Extremely intense exertion may cause heat stress."
  }
  
  # 1. Start with the physical hazard
  is_dangerous <- wbgt >= 88.0 # 'Red Flag' WBGT

  # 2. Agriculture-Specific Policy Triggers
  if (is_dangerous && ag_pct > 15) {
    msg <- c(msg, "ACTION: Activate emergency radio broadcasts (Spanish/Indigenous languages).")
  }
  
  # 3. Compensation Trigger (Addressing 'Lost Wages')
  if (is_dangerous && raw_poverty > 35) {
    msg <- c(msg, "POLICY: Initiate 'Heat-Day' wage compensation for field laborers.")
  }
  
  # 4. Infrastructure Trigger (Cooling Centers)
  if (wbgt >= 90) {
    msg <- c(msg, "INFRASTRUCTURE: Deploy mobile cooling stations to agricultural hubs.")
  }
  
  return(list(flag = flag, msg = msg))
}
```

Apply our location:

```{r chunk18}
pt_responses <- safety_msg(
  wbgt = pt_wbgt_max, 
  ag_pct = pt_agemp, 
  pov_raw = pt_socecon_lst$pov_raw, 
  ling_iso_raw = pt_socecon_lst$ling_iso_raw
)
```

View the responses:

```{r chunk19}
pt_responses
```

